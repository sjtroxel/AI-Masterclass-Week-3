# Workflow Templates

Complete, ready-to-use GitHub Actions workflow templates. Generation phase reads these and customizes with discovered project details.

Replace these placeholders during generation:
- `[BRANCH]` — user's selected target branch (main, master, develop, etc.)
- `[ECOSYSTEM]` — detected package ecosystem (npm, pip, cargo, composer, bundler, gomod, etc.)
- `[TEST_COMMAND]`, `[LINT_COMMAND]`, `[BUILD_COMMAND]` — discovered from package.json/Makefile/etc.

---

## 1. claude-review.yml — Claude Code PR Review

Triggers on every PR. Claude reviews for bugs, security, conventions, and test coverage.

```yaml
# Generated by ai-ci-onboard skill — customize as needed
name: Claude Code PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ["[BRANCH]"]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            Review this PR for:
            1. Bugs and logic errors
            2. Security vulnerabilities
            3. Adherence to project conventions (see CLAUDE.md and .claude/rules/)
            4. Test coverage for new code
            Post your review as a PR comment with specific, actionable feedback.
```

---

## 2. gitleaks.yml — Secret Scanning

Scans every push and PR for hardcoded credentials, API keys, and tokens.

```yaml
# Generated by ai-ci-onboard skill — customize as needed
name: Secret Scanning

on:
  push:
    branches: ["[BRANCH]"]
  pull_request:
    branches: ["[BRANCH]"]

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 3. dependabot.yml — Automated Dependency Updates

Opens PRs for dependency updates weekly. Write to `.github/dependabot.yml` (NOT in workflows/).

If multiple ecosystems are detected (e.g., npm + github-actions), include an entry for each.

Always include a `github-actions` entry to keep action versions current.

```yaml
# Generated by ai-ci-onboard skill — customize as needed
version: 2
updates:
  - package-ecosystem: "[ECOSYSTEM]"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
    open-pull-requests-limit: 5
    labels:
      - "dependencies"
    ignore:
      - dependency-name: "*"
        update-types: ["version-update:semver-major"]

  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
    open-pull-requests-limit: 5
    labels:
      - "dependencies"
```

### Ecosystem mapping

Use this to map detected project files to dependabot ecosystem values:
- `package.json` / `package-lock.json` / `yarn.lock` → `npm`
- `requirements.txt` / `Pipfile` / `pyproject.toml` → `pip`
- `Cargo.toml` → `cargo`
- `composer.json` → `composer`
- `Gemfile` → `bundler`
- `go.mod` → `gomod`
- `pom.xml` → `maven`
- `build.gradle` → `gradle`
- `.github/workflows/*.yml` → `github-actions` (always include)

---

## 4. label-workflow.yml — Specify→Plan→Develop Pipeline

This generates **3 separate workflow files** implementing a label-based state machine with human approval gates between each stage.

### How it works

```
Issue created
  → human applies: needs:specify
    → Claude writes specification as issue comment
    → Claude applies: review:specify (human checkpoint)
      → human approves, applies: needs:plan
        → Claude writes implementation plan as issue comment
        → Claude applies: review:plan (human checkpoint)
          → human approves, applies: needs:develop
            → Claude implements code and opens PR
            → Claude applies: review:develop (human reviews PR)
```

Each `review:*` label is a human checkpoint — no automation advances past it without human action.

### Required GitHub labels

Create these labels in the repository before using:
- `needs:specify` / `review:specify`
- `needs:plan` / `review:plan`
- `needs:develop` / `review:develop`

### File 1: claude-specify.yml

```yaml
# Generated by ai-ci-onboard skill — customize as needed
#
# Stage 1 of the Specify→Plan→Develop pipeline.
# Trigger: apply the "needs:specify" label to an issue.
# Claude reads the issue and writes a structured specification as a comment.
# Human reviews the spec, then applies "needs:plan" to advance.
name: "Claude - Specify"

on:
  issues:
    types: [labeled]

jobs:
  specify:
    if: github.event.label.name == 'needs:specify'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "needs:specify"
          prompt: |
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            ## Your Task: Write a Specification

            Read the issue above and the project's CLAUDE.md and .claude/rules/ for context.
            Produce a structured specification comment on this issue:

            1. **Problem Statement** — what problem are we solving and why
            2. **Proposed Solution** — high-level approach
            3. **Acceptance Criteria** — bulleted, testable conditions for "done"
            4. **Out of Scope** — what this does NOT cover
            5. **Open Questions** — anything needing human input before planning

            After posting the specification:
            - Remove the label `needs:specify`
            - Add the label `review:specify`

            Use: gh issue edit ${{ github.event.issue.number }} --remove-label "needs:specify" --add-label "review:specify"
```

### File 2: claude-plan.yml

```yaml
# Generated by ai-ci-onboard skill — customize as needed
#
# Stage 2 of the Specify→Plan→Develop pipeline.
# Trigger: apply the "needs:plan" label to an issue (after reviewing the spec).
# Claude reads the spec and writes an implementation plan as a comment.
# Human reviews the plan, then applies "needs:develop" to advance.
name: "Claude - Plan"

on:
  issues:
    types: [labeled]

jobs:
  plan:
    if: github.event.label.name == 'needs:plan'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "needs:plan"
          prompt: |
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Read the full issue thread including the specification comment.
            Read the project's CLAUDE.md and .claude/rules/ for context.

            ## Your Task: Write an Implementation Plan

            Produce a detailed implementation plan comment:

            1. **File Changes** — every file to create, modify, or delete
            2. **Step-by-Step Tasks** — ordered checklist of implementation steps
            3. **Testing Plan** — what tests to write, what to verify
            4. **Risk / Edge Cases** — what could go wrong
            5. **Estimated Complexity** — XS / S / M / L / XL

            After posting the plan:
            - Remove the label `needs:plan`
            - Add the label `review:plan`

            Use: gh issue edit ${{ github.event.issue.number }} --remove-label "needs:plan" --add-label "review:plan"
```

### File 3: claude-develop.yml

```yaml
# Generated by ai-ci-onboard skill — customize as needed
#
# Stage 3 of the Specify→Plan→Develop pipeline.
# Trigger: apply the "needs:develop" label to an issue (after reviewing the plan).
# Claude implements the code per the plan and opens a PR.
# Human reviews the PR (the final approval gate).
name: "Claude - Develop"

on:
  issues:
    types: [labeled]

jobs:
  develop:
    if: github.event.label.name == 'needs:develop'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "needs:develop"
          prompt: |
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Read the full issue thread — the specification and implementation plan are in the comments.
            Read the project's CLAUDE.md and .claude/rules/ for context.

            ## Your Task: Implement the Code

            Follow the implementation plan from the issue comments. Then:
            1. Create a feature branch named `claude/${{ github.event.issue.number }}-<short-description>`
            2. Implement all changes per the plan
            3. Write tests as specified in the plan
            4. Run existing tests to check for regressions
            5. Create a PR with title referencing the issue and body containing `Closes #${{ github.event.issue.number }}`
            6. Remove the label `needs:develop` and add `review:develop`

            Use:
            ```
            gh pr create --title "<descriptive title>" --body "Closes #${{ github.event.issue.number }}"
            gh issue edit ${{ github.event.issue.number }} --remove-label "needs:develop" --add-label "review:develop"
            ```
```
